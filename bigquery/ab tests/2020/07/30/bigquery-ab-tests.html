<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>A/B tests with hashes in BigQuery | ben’s blog</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="A/B tests with hashes in BigQuery" />
<meta name="author" content="bbernst" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Notebooks and posts to share" />
<meta property="og:description" content="Notebooks and posts to share" />
<link rel="canonical" href="https://bbernst.github.io/blog/bigquery/ab%20tests/2020/07/30/bigquery-ab-tests.html" />
<meta property="og:url" content="https://bbernst.github.io/blog/bigquery/ab%20tests/2020/07/30/bigquery-ab-tests.html" />
<meta property="og:site_name" content="ben’s blog" />
<meta property="og:image" content="https://bbernst.github.io/blog/images/bigquery-ab-tests/dists.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-30T00:00:00-05:00" />
<script type="application/ld+json">
{"datePublished":"2020-07-30T00:00:00-05:00","author":{"@type":"Person","name":"bbernst"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://bbernst.github.io/blog/bigquery/ab%20tests/2020/07/30/bigquery-ab-tests.html"},"image":"https://bbernst.github.io/blog/images/bigquery-ab-tests/dists.png","description":"Notebooks and posts to share","@type":"BlogPosting","url":"https://bbernst.github.io/blog/bigquery/ab%20tests/2020/07/30/bigquery-ab-tests.html","headline":"A/B tests with hashes in BigQuery","dateModified":"2020-07-30T00:00:00-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://bbernst.github.io/blog/feed.xml" title="ben's blog" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-172710437-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog/">ben&#39;s blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog/about/">About Me</a><a class="page-link" href="/blog/search/">Search</a><a class="page-link" href="/blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">A/B tests with hashes in BigQuery</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-07-30T00:00:00-05:00" itemprop="datePublished">
        Jul 30, 2020
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">bbernst</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      6 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#bigquery">bigquery</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#ab tests">ab tests</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/bbernst/blog/tree/master/_notebooks/2020-07-30-bigquery-ab-tests.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/blog/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          <div class="px-2">
    <a href="https://colab.research.google.com/github/bbernst/blog/blob/master/_notebooks/2020-07-30-bigquery-ab-tests.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/blog/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#An-example-problem">An example problem </a></li>
<li class="toc-entry toc-h1"><a href="#Solution">Solution </a>
<ul>
<li class="toc-entry toc-h2"><a href="#UDFs">UDFs </a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#Aside-on-Inverse-Transform-Sampling">Aside on Inverse Transform Sampling </a></li>
<li class="toc-entry toc-h1"><a href="#A/B-tests">A/B tests </a></li>
<li class="toc-entry toc-h1"><a href="#Conclusion">Conclusion </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-07-30-bigquery-ab-tests.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="An-example-problem">
<a class="anchor" href="#An-example-problem" aria-hidden="true"><span class="octicon octicon-link"></span></a>An example problem<a class="anchor-link" href="#An-example-problem"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Recently, I've needed to generate random but consistent values in a BigQuery data pipeline. This is a pipeline that runs many times per day and constantly has new data feeding in through upstream pipes.</p>
<p>As an example, let's say that we have 10,000 users and need to randomly place them into groups depending on the hour of the work day. Additionally, we only want to do this once; once a user gets placed into a group, they stay in that group. This way, downstream work can rely on how each user is assigned without having to worry about checking for changes. Visually, this looks like:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>hour</th>
      <th>user_ids</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>9</td>
      <td>~1000 random users</td>
    </tr>
    <tr>
      <th>1</th>
      <td>10</td>
      <td>~1000 random users</td>
    </tr>
    <tr>
      <th>2</th>
      <td>11</td>
      <td>~1000 random users</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12</td>
      <td>~1000 random users</td>
    </tr>
    <tr>
      <th>4</th>
      <td>13</td>
      <td>~1000 random users</td>
    </tr>
    <tr>
      <th>5</th>
      <td>14</td>
      <td>~1000 random users</td>
    </tr>
    <tr>
      <th>6</th>
      <td>15</td>
      <td>~1000 random users</td>
    </tr>
    <tr>
      <th>7</th>
      <td>16</td>
      <td>~1000 random users</td>
    </tr>
    <tr>
      <th>8</th>
      <td>17</td>
      <td>~1000 random users</td>
    </tr>
    <tr>
      <th>9</th>
      <td>18</td>
      <td>~1000 random users</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>BigQuery has a number of functions for producing random numbers, like <code>RAND()</code>, and we can create the table above with a query:</p>
<div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="n">src</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span>
    <span class="n">user_id</span><span class="p">,</span>
    <span class="k">CAST</span><span class="p">(</span><span class="n">FLOOR</span><span class="p">(</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">RAND</span><span class="p">())</span> <span class="k">AS</span> <span class="n">INT64</span><span class="p">)</span> <span class="k">AS</span> <span class="n">hour</span>
  <span class="k">FROM</span> <span class="k">UNNEST</span><span class="p">(</span><span class="n">GENERATE_ARRAY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span> <span class="n">user_id</span>
<span class="p">)</span>

<span class="k">SELECT</span> 
  <span class="n">hour</span><span class="p">,</span>
  <span class="n">ARRAY_AGG</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">user_ids</span>
<span class="k">FROM</span> <span class="n">src</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">hour</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">hour</span>
</pre></div>
<p>However, this query produces <em>new</em> random groups each time the query is run. There's no built-in way to specify a seed in <code>RAND()</code>, so we'll need to learn how to create a <code>CONSISTENT_RAND(...)</code> ourselves.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Solution">
<a class="anchor" href="#Solution" aria-hidden="true"><span class="octicon octicon-link"></span></a>Solution<a class="anchor-link" href="#Solution"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This <a href="http://blog.richardweiss.org/2016/12/25/hash-splits.html">thorough post</a> solves our problem, gives us python and SQL code, but unfortunately not for the BigQuery dialect.</p>
<p>Let's build this up for BigQuery step by step within the <code>src</code> CTE:</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="n">user_id</span><span class="p">,</span>
    <span class="n">CONCAT</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s1">'salt'</span><span class="p">)</span> <span class="k">AS</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">MD5</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s1">'salt'</span><span class="p">))</span> <span class="k">AS</span> <span class="n">md5_key</span><span class="p">,</span>
    <span class="n">TO_HEX</span><span class="p">(</span><span class="n">MD5</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s1">'salt'</span><span class="p">)))</span> <span class="k">AS</span> <span class="n">hex_md5_key</span><span class="p">,</span>
    <span class="n">SUBSTR</span><span class="p">(</span><span class="n">TO_HEX</span><span class="p">(</span><span class="n">MD5</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s1">'salt'</span><span class="p">))),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="k">AS</span> <span class="n">substr_hex_md5_key</span><span class="p">,</span>
    <span class="n">CONCAT</span><span class="p">(</span><span class="s1">'0x'</span><span class="p">,</span> <span class="n">SUBSTR</span><span class="p">(</span><span class="n">TO_HEX</span><span class="p">(</span><span class="n">MD5</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s1">'salt'</span><span class="p">))),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="n">correct_hex</span><span class="p">,</span>
    <span class="k">CAST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">'0x'</span><span class="p">,</span> <span class="n">SUBSTR</span><span class="p">(</span><span class="n">TO_HEX</span><span class="p">(</span><span class="n">MD5</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s1">'salt'</span><span class="p">))),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="k">AS</span> <span class="n">INT64</span><span class="p">)</span> <span class="k">AS</span> <span class="n">numerator</span><span class="p">,</span>
    <span class="k">CAST</span><span class="p">(</span><span class="s1">'0xFFFFFF'</span> <span class="k">AS</span> <span class="n">INT64</span><span class="p">)</span> <span class="k">AS</span> <span class="n">denominator</span><span class="p">,</span>
    <span class="k">CAST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">'0x'</span><span class="p">,</span> <span class="n">SUBSTR</span><span class="p">(</span><span class="n">TO_HEX</span><span class="p">(</span><span class="n">MD5</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s1">'salt'</span><span class="p">))),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="k">AS</span> <span class="n">INT64</span><span class="p">)</span> <span class="o">/</span> 
      <span class="k">CAST</span><span class="p">(</span><span class="s1">'0xFFFFFF'</span> <span class="k">AS</span> <span class="n">INT64</span><span class="p">)</span> <span class="k">AS</span> <span class="n">consistent_rand</span>
  <span class="k">FROM</span> <span class="k">UNNEST</span><span class="p">(</span><span class="n">GENERATE_ARRAY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span> <span class="n">user_id</span>
</pre></div>
<ol>
<li>
<code>key</code>: Allows us to effectively set a seed using <code>user_id</code> and a <code>salt</code>
</li>
<li>
<code>md5_key</code>: Hash the <code>key</code> with <code>MD5()</code>
</li>
<li>
<code>hex_md5_key</code>: Convert <code>md5_key</code> with <code>TO_HEX()</code>
</li>
<li>
<code>substr_hex_md5_key</code>: Take the first 6 digits of <code>hex_md5_key</code>
</li>
<li>
<code>correct_hex</code>: Prepend 0x to <code>correct_hex</code> since all hex values start with 0x</li>
<li>
<code>numerator</code>: Convert <code>correct_hex</code> to an integer because we want to get to a number</li>
<li>
<code>denominator</code>: Convert 0xFFFFFF to an integer because it's the largest 6 digit hex value</li>
<li>
<code>consistent_rand</code>: Divide <code>numerator</code> and <code>denominator</code> to get a value between 0 and 1</li>
</ol>
<p>And putting this all together for our problem:</p>
<div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="n">src</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span>
    <span class="n">user_id</span><span class="p">,</span>
    <span class="k">CAST</span><span class="p">(</span><span class="n">FLOOR</span><span class="p">(</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span>
      <span class="k">CAST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">'0x'</span><span class="p">,</span> <span class="n">SUBSTR</span><span class="p">(</span><span class="n">TO_HEX</span><span class="p">(</span><span class="n">MD5</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s1">'salt'</span><span class="p">))),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="k">AS</span> <span class="n">INT64</span><span class="p">)</span> <span class="o">/</span> 
      <span class="k">CAST</span><span class="p">(</span><span class="s1">'0xFFFFFF'</span> <span class="k">AS</span> <span class="n">INT64</span><span class="p">)</span>
    <span class="p">)</span> <span class="k">AS</span> <span class="n">INT64</span><span class="p">)</span> <span class="k">AS</span> <span class="n">hour</span>
  <span class="k">FROM</span> <span class="k">UNNEST</span><span class="p">(</span><span class="n">GENERATE_ARRAY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span> <span class="n">user_id</span>
<span class="p">)</span>

<span class="k">SELECT</span> 
  <span class="n">hour</span><span class="p">,</span> 
  <span class="n">ARRAY_AGG</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">user_ids</span>
<span class="k">FROM</span> <span class="n">src</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">hour</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">hour</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="UDFs">
<a class="anchor" href="#UDFs" aria-hidden="true"><span class="octicon octicon-link"></span></a>UDFs<a class="anchor-link" href="#UDFs"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We've achieved the goal, but we can clean this up to save ourselves some copy and paste steps in the future. BigQuery let's us define UDFs (user defined functions):</p>
<div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="o">`</span><span class="n">project</span><span class="p">.</span><span class="n">dataset</span><span class="p">.</span><span class="n">CONSISTENT_RAND</span><span class="o">`</span> <span class="p">(</span>
  <span class="k">key</span> <span class="n">STRING</span>
<span class="p">)</span>
<span class="k">RETURNS</span> <span class="n">FLOAT64</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">CAST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">'0x'</span><span class="p">,</span> <span class="n">SUBSTR</span><span class="p">(</span><span class="n">TO_HEX</span><span class="p">(</span><span class="n">MD5</span><span class="p">(</span><span class="k">key</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="k">AS</span> <span class="n">INT64</span><span class="p">)</span> <span class="o">/</span> 
  <span class="k">CAST</span><span class="p">(</span><span class="s1">'0xFFFFFF'</span> <span class="k">AS</span> <span class="n">INT64</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
<p>Now, it's a more convenient query to write:</p>
<div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="n">src</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span>
    <span class="n">user_id</span><span class="p">,</span>
    <span class="k">CAST</span><span class="p">(</span><span class="n">FLOOR</span><span class="p">(</span><span class="mi">9</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span>
      <span class="o">`</span><span class="n">project</span><span class="p">.</span><span class="n">dataset</span><span class="p">.</span><span class="n">CONSISTENT_RAND</span><span class="o">`</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s1">'salt'</span><span class="p">))</span>
    <span class="p">)</span> <span class="k">AS</span> <span class="n">INT64</span><span class="p">)</span> <span class="k">AS</span> <span class="n">hour</span>
  <span class="k">FROM</span> <span class="k">UNNEST</span><span class="p">(</span><span class="n">GENERATE_ARRAY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span> <span class="n">user_id</span>
<span class="p">)</span>

<span class="k">SELECT</span> 
  <span class="n">hour</span><span class="p">,</span> 
  <span class="n">ARRAY_AGG</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">user_ids</span>
<span class="k">FROM</span> <span class="n">src</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">hour</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">hour</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Aside-on-Inverse-Transform-Sampling">
<a class="anchor" href="#Aside-on-Inverse-Transform-Sampling" aria-hidden="true"><span class="octicon octicon-link"></span></a>Aside on Inverse Transform Sampling<a class="anchor-link" href="#Aside-on-Inverse-Transform-Sampling"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Something implicit in the above example is the mapping from a uniform random number in [0,1], the result of <code>RAND()</code> and <code>CONSISTENT_RAND()</code>, to a uniform random number between [9, 19], the hour. It's pretty intuitive that you can take something uniform, space the points out a bit, and it stays uniform, but there's also theory behind it -- <a href="https://en.wikipedia.org/wiki/Inverse_transform_sampling">Inverse transform sampling</a>.</p>
<p>For the uniform to uniform case we have our sampler, $ U \sim Unif(0,1) $ and our hours, $ H \sim Unif(9,19) $.</p>
<p>The <a href="https://en.wikipedia.org/wiki/Uniform_distribution_%28continuous%29#Cumulative_distribution_function">CDF</a> for H is:
$$
F(x) = \frac{x-9}{10}
$$
And we want to solve:
$$
F(F^{-1}(u)) = u \\
\frac{F^{-1}(u)-9}{10} = u \\
F^{-1}(u) = 9 + 10 * u
$$</p>
<p>Check it out! We found $ 9 + 10 * u $ which is exactly what we've be writing in our queries: <code>9 + 10 * CONSISTENT_RAND(key)</code>.</p>
<p>Now, what if we switch the problem to something slightly different and instead of spreading out our users evenly throughout the day, we want them to spread out according to an exponential distribution. This way more users fall into earlier hours and fewer into later hours -- maybe the downstream work is easier to do early in the day before people get tired. Also let's forget about the working day hours for this part.</p>
<p>For the uniform to exponential case we have our sampler, $ U \sim Unif(0,1) $ and our hours, $ H \sim Expon(1) $.</p>
<p>The <a href="https://en.wikipedia.org/wiki/Exponential_distribution#Cumulative_distribution_function">CDF</a> for H is:
$$
F(x) = 1 - e^{-x}
$$
And, like before, we want to solve:
$$
F(F^{-1}(u)) = u \\
1 - e^{-F^{-1}(u)} = u \\
e^{-F^{-1}(u)} = 1 - u \\
-F^{-1}(u) = ln(1 - u) \\
F^{-1}(u) = -ln(1 - u)
$$</p>
<p>In BigQuery we can write <code>-1 * LN(1 - CONSISTENT_RAND(key))</code> and our groups will follow the exponential distribution.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="A/B-tests">
<a class="anchor" href="#A/B-tests" aria-hidden="true"><span class="octicon octicon-link"></span></a>A/B tests<a class="anchor-link" href="#A/B-tests"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You might be asking, what does this have to do with A/B tests? When creating an A/B test, we often want to:</p>
<ol>
<li>Randomly and consistently place users into test groups</li>
<li>Allow new users to get into existing groups as they arrive</li>
<li>Make sure those assignments don't change over time</li>
</ol>
<p>This turns out to be very similar to what we have laid out above and we can show it with a quick, familiar query. Our goal is to split our 10,000 users into two evenly sized groups, <code>A</code> and <code>B</code>:</p>
<div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="n">src</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span>
    <span class="n">user_id</span><span class="p">,</span>
    <span class="o">`</span><span class="n">project</span><span class="p">.</span><span class="n">dataset</span><span class="p">.</span><span class="n">CONSISTENT_RAND</span><span class="o">`</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s1">'ab_test_1'</span><span class="p">))</span> <span class="k">AS</span> <span class="n">u</span>
  <span class="k">FROM</span> <span class="k">UNNEST</span><span class="p">(</span><span class="n">GENERATE_ARRAY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span> <span class="n">user_id</span>
<span class="p">)</span>

<span class="k">SELECT</span> 
  <span class="k">CASE</span>
    <span class="k">WHEN</span> <span class="n">u</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span> <span class="k">THEN</span> <span class="s1">'A'</span>
    <span class="k">ELSE</span> <span class="s1">'B'</span>
  <span class="k">END</span> <span class="k">AS</span> <span class="n">test_group</span><span class="p">,</span> 
  <span class="n">ARRAY_AGG</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">user_ids</span><span class="p">,</span>
  <span class="k">COUNT</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">group_size</span>
<span class="k">FROM</span> <span class="n">src</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">test_group</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">test_group</span>
</pre></div>
<p>If we use the combination of <code>user_id</code> and the name of the test as the salt, <code>ab_test_1</code>, then we can make sure that a user will always be in the same group for that test. And since our pipeline runs many times during the day, any new users will automatically be placed into a group during each run. Last, if we wanted to change from equal group sizes, then we can simply change the <code>0.5</code> split to any number within <code>[0,1]</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Conclusion">
<a class="anchor" href="#Conclusion" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusion<a class="anchor-link" href="#Conclusion"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In the end, we've created a tidy UDF in BigQuery to help create random and consistent values that we can use for making A/B test groups and when working within idempotent data pipelines.</p>

</div>
</div>
</div>
</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="bbernst/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/bigquery/ab%20tests/2020/07/30/bigquery-ab-tests.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Notebooks and posts to share</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/bbernst" title="bbernst"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/bbernst" title="bbernst"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
